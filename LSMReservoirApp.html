
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>LSMReservoirApp</title><meta name="generator" content="MATLAB 9.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2019-04-06"><meta name="DC.source" content="LSMReservoirApp.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Simulate 3D SNN reservoir in Liquid State Machine (LSM)</a></li><li><a href="#2">Reset random number generator</a></li><li><a href="#3">Default configuration settings (could be modified in GUI)</a></li><li><a href="#4">Configuration parameters</a></li><li><a href="#5">Reservoir parameters</a></li><li><a href="#7">Create 3D reservoir network</a></li><li><a href="#8">Get secondary parameters</a></li><li><a href="#9">Input mapping of spikes</a></li><li><a href="#10">Values from the Literature : Zhang et al. 2015</a></li><li><a href="#11">Update synaptic scaling</a></li><li><a href="#12">Create figure handles and GUI</a></li><li><a href="#13">Create sliders</a></li><li><a href="#14">Create checkboxes</a></li><li><a href="#15">Text information string</a></li><li><a href="#16">Create listener to push buttons</a></li><li><a href="#17">Run main code</a></li><li><a href="#18">Helper Functions</a></li><li><a href="#19">Generate New Network</a></li><li><a href="#20">Update config values</a></li><li><a href="#21">Show synaptic model</a></li><li><a href="#22">Show reservoir spike distribution by neuron</a></li><li><a href="#23">Update main plot</a></li></ul></div><h2 id="1">Simulate 3D SNN reservoir in Liquid State Machine (LSM)</h2><pre class="codeinput"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="comment">% Simulates reservoir in a LSM and is useful in :</span>
<span class="comment">%   * tuning the synaptic weights to get various dynamics(oscillatory,</span>
<span class="comment">%   decaying, saturation)</span>
<span class="comment">%   * observe effect of changing individual network parameter to find</span>
<span class="comment">%   sensitivity of parameters</span>
<span class="comment">%</span>
<span class="comment">% Author - Ajinkya Gorad</span>
<span class="comment">% LSMReservoir@2019 (version-0.8)</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>


<span class="keyword">function</span> LSMReservoirApp
</pre><h2 id="2">Reset random number generator</h2><pre class="codeinput">rng(0);
</pre><h2 id="3">Default configuration settings (could be modified in GUI)</h2><pre class="codeinput">STDP = 0;       <span class="comment">% Spike Timing Dependent Plasticity</span>
SAVE_VIDEO=0;   <span class="comment">% Save the simulation frame by frame for each param setting</span>
NOISE = 0;      <span class="comment">% noise in membrane potential of neurons</span>
TWO_SPIKES = 0; <span class="comment">% Only give two input spikes</span>
POISSON =0;     <span class="comment">% Poisson spike inputs</span>
</pre><h2 id="4">Configuration parameters</h2><pre class="codeinput">eta = 0;        <span class="comment">% noise level (NOISE only)</span>
lambdaIn = 10;  <span class="comment">% Poisson input spike rate (POISSON only)</span>
DeltaT = 0;     <span class="comment">% Separation between two spike input (TWO_SPIKES only)</span>
</pre><h2 id="5">Reservoir parameters</h2><pre class="codeinput">W0 = [3 6;-2 -2];   <span class="comment">% Initial weights in the reservoir (E-&gt;E, E-&gt;I; I-&gt;E, I-&gt;I) Excitatory(E), Inhibitory(I)</span>
K0 = [0.45 0.3;0.6 0.15];   <span class="comment">% Probability coefficients for reservoir connections</span>
Wee  = W0(1,1); Wei= W0(1,2); Wie= W0(2,1); Wii = W0(2,2); <span class="comment">% assign individual weights</span>
Wm =50;              <span class="comment">% Maximum limit for reservoir weight synaptic scaling (SLIDER)</span>
alpha_G = 1;            <span class="comment">% default synaptic scaling parameter</span>
resSize= [5 5 5];    <span class="comment">% 3D reservoir size</span>
r0 = 2;              <span class="comment">% effective connectivity distance parameter for gaussian profile</span>
f_inhibit=0.2;       <span class="comment">% fraction of inhibitory neurons in reservoir</span>
d_syn = 1E-3;        <span class="comment">% Synaptic Delay in reservoir (FIXED)</span>
</pre><pre class="codeinput"><span class="keyword">if</span>(SAVE_VIDEO)
    writerObj = VideoWriter(<span class="string">'media\STOCH_RES2.mp4'</span>);
    open(writerObj);
<span class="keyword">end</span>
</pre><h2 id="7">Create 3D reservoir network</h2><p>createNetworkM creates an multidimensional graph on N-D grid with dimensions(M) = lenght(resSize) and neuron at each ND-point (n1,...,nM) X : source node of network graph Xn : destination node of network graph T : synaptic delay for each neuron (FIXED) W : weight of each synapse R : coordinates of each neuron E : value for choosing excitatory(1)/inhibitory(-1) neuron</p><pre class="codeinput">[X,Xn,T,W,R,E] = createNetworkM(resSize,W0,r0,K0,f_inhibit,d_syn); <span class="comment">% gaussian probablistically connected network</span>
</pre><pre class="codeoutput">Reservoir with size [5 5 5] created 2783/125 
</pre><h2 id="8">Get secondary parameters</h2><pre class="codeinput">Nres = length(E);   <span class="comment">% number of reservoir neurons</span>
V = zeros(Nres,1);  <span class="comment">% Membrane potential of reservoir Neurons</span>
v = zeros(Nres,3);  <span class="comment">% Synaptic traces</span>
I = zeros(Nres,3);  <span class="comment">% Neuron input current</span>
spiked = logical(zeros(Nres,1)); <span class="comment">% to store spiked neurons at an instant</span>
spikedLog =logical(sparse([])); <span class="comment">% to store spiked neurons in all simulated time &lt;K</span>
G = sparse(X,Xn,W); <span class="comment">% Sparse matrix is better to store loosely connected networks</span>
G0=G;    <span class="comment">% save default configuration for network weights and connectivity</span>

<span class="comment">% STDP definitions</span>
dGp = -1; dGn = 1; <span class="comment">% weight/conductance (G) update rate</span>
A = sparse(zeros(size(G)));
A(E&gt;0,E&gt;0) = 1;A(E&gt;0,E&lt;0) = 1; <span class="comment">% Define coefficients for STDP</span>
A(E&lt;0,E&gt;0) = 1;A(E&lt;0,E&lt;0) = 1; <span class="comment">%  -;;-</span>
A = A.*logical(G);  <span class="comment">% get the graph connectivity matrix A</span>
</pre><h2 id="9">Input mapping of spikes</h2><pre class="codeinput">Gin=ones(Nres,1)*8;     <span class="comment">% Defines input weights for each neuron</span>
Iapp = zeros(Nres,1);   <span class="comment">% Externally applied current for each neuron</span>
inFrac=0.9;             <span class="comment">% Fraction of reservoir  neurons which take input</span>
</pre><h2 id="10">Values from the Literature : Zhang et al. 2015</h2><pre class="codeinput">dt = 1E-3; <span class="comment">% Define time step of simulation</span>
K = 2000;  <span class="comment">% Define time of simulation</span>
alphaV = (1-dt/20E-3); <span class="comment">% membrane decay constant (discrete)</span>
alpha1E = (1-dt/40E-3);alpha2E =(1-dt/6E-3); <span class="comment">% synaptic trace decay constants</span>
alpha3stdp = (1-dt/10E-3); <span class="comment">% used in STDP</span>
alpha1I = (1-dt/30E-3); alpha2I = (1-dt/4E-3);
<span class="comment">% create and assign matrices</span>
alpha1 = zeros(Nres,1); alpha2 = alpha1; alpha3 = alpha1;
Kt0e=0;Kt0i=0;Kt0=zeros(Nres,1);
alpha1(E&gt;0) = alpha1E; alpha2(E&gt;0) = alpha2E; alpha3(:) = alpha3stdp;
alpha1(E&lt;0) = alpha1I; alpha2(E&lt;0) = alpha2I;
Vth = 20;       <span class="comment">% Threshold voltage (mV)</span>
</pre><h2 id="11">Update synaptic scaling</h2><pre class="codeinput"><span class="comment">%updateKt0();</span>
</pre><h2 id="12">Create figure handles and GUI</h2><pre class="codeinput">fig_handle = figure(<span class="string">'name'</span>,<span class="string">'simulation'</span>); <span class="comment">% Main figure window</span>
set(fig_handle, <span class="string">'Position'</span>, [0, 0, 1280, 600]); <span class="comment">% Defines the size of main window</span>
text_subplot = axes(<span class="string">'Position'</span>,[0 0 0.2 1],<span class="string">'Visible'</span>,<span class="string">'off'</span>);infoText=text(0.05,0.65,<span class="string">' '</span>,<span class="string">'FontSize'</span>,10); <span class="comment">% Information region</span>
raster_subplot = axes(<span class="string">'Position'</span>,[.2 0.1 .55 .35]);     <span class="comment">% reservoir spikes</span>
input_subplot = axes(<span class="string">'Position'</span>,[.2 0.6 .55 .35]);      <span class="comment">% input Spikes (to each neuron)</span>
psp_subplot = axes(<span class="string">'Position'</span>,[.8 0.6 .15 .35]);        <span class="comment">% Synaptic model/Reservoir distribution</span>
activity_subplot = axes(<span class="string">'Position'</span>,[.8 0.1 .15 0.35]);  <span class="comment">% Spike activity with time</span>
glog_subplot = axes(<span class="string">'Position'</span>,[0.025 0.8 0.15 0.2],<span class="string">'Visible'</span>,<span class="string">'off'</span>); <span class="comment">% Weight update (STDP only)</span>
set(gcf,<span class="string">'Color'</span>,<span class="string">'w'</span>);
</pre><img vspace="5" hspace="5" src="LSMReservoirApp_01.png" alt=""> <h2 id="13">Create sliders</h2><pre class="codeinput">axes(text_subplot);
slidebarW=200; <span class="comment">% width in pixel for slider</span>
slhan=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alpha_G'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alpha_G'</span>,<span class="string">'position'</span>,[0 0 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan2=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'inFrac'</span>,<span class="string">'TooltipString'</span>,<span class="string">'inFrac'</span>,<span class="string">'position'</span>,[0 10 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan3=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alpha1E'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alpha1E'</span>,<span class="string">'position'</span>,[0 20 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan4=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alpha2E'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alpha2E'</span>,<span class="string">'position'</span>,[0 30 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan5=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alphaV'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alphaV'</span>,<span class="string">'position'</span>,[0 40 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan6=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alpha1I'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alpha1I'</span>,<span class="string">'position'</span>,[0 50 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan7=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'alpha2I'</span>,<span class="string">'TooltipString'</span>,<span class="string">'alpha2I'</span>,<span class="string">'position'</span>,[0 60 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan8=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Vth'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Vth'</span>,<span class="string">'position'</span>,[0 70 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan9=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Wee'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Wee'</span>,<span class="string">'position'</span>,[0 80 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1,<span class="string">'SliderStep'</span>,[1/10/50 2/50],<span class="string">'BackgroundColor'</span>,[0.0 0.5 0.2],<span class="string">'Value'</span>,Wee/Wm);
slhan10=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Wei'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Wei'</span>,<span class="string">'position'</span>,[0 90 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1,<span class="string">'SliderStep'</span>,[1/10/50 2/50],<span class="string">'BackgroundColor'</span>,[0.2 0.5 0.2],<span class="string">'Value'</span>,Wei/Wm);
slhan11=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Wie'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Wie'</span>,<span class="string">'position'</span>,[0 100 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1,<span class="string">'SliderStep'</span>,[1/10/50 2/50],<span class="string">'BackgroundColor'</span>,[0.5 0.2 0.2],<span class="string">'Value'</span>,-Wie/Wm);
slhan12=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Wii'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Wii'</span>,<span class="string">'position'</span>,[0 110 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1,<span class="string">'SliderStep'</span>,[1/10/50 2/50],<span class="string">'BackgroundColor'</span>,[0.5 0.0 0.2],<span class="string">'Value'</span>,-Wii/Wm);
slhan13=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'Noise'</span>,<span class="string">'TooltipString'</span>,<span class="string">'Noise'</span>,<span class="string">'position'</span>,[0 120 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan14=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'lambdaIn'</span>,<span class="string">'TooltipString'</span>,<span class="string">'lambdaIn'</span>,<span class="string">'position'</span>,[0 130 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1);
slhan15=uicontrol(<span class="string">'style'</span>,<span class="string">'slider'</span>,<span class="string">'String'</span>,<span class="string">'DeltaT'</span>,<span class="string">'TooltipString'</span>,<span class="string">'DeltaT'</span>,<span class="string">'position'</span>,[0 140 slidebarW 10],<span class="string">'min'</span>,0,<span class="string">'max'</span>,1, <span class="string">'SliderStep'</span>,[1/800 50/800]);
</pre><img vspace="5" hspace="5" src="LSMReservoirApp_02.png" alt=""> <h2 id="14">Create checkboxes</h2><pre class="codeinput">endsliderY = 140; <span class="comment">% width in pixel for checkbox</span>
chkbx1 = uicontrol(<span class="string">'style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'STDP'</span>,<span class="string">'position'</span>,[0 endsliderY+10 80 10],<span class="string">'Value'</span>,STDP,<span class="string">'callback'</span>,@ifSTDP);
chkbx2 = uicontrol(<span class="string">'style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'PoissonTrain'</span>,<span class="string">'position'</span>,[0 endsliderY+20 80 10],<span class="string">'Value'</span>,POISSON,<span class="string">'callback'</span>,@ifPoisson);
chkbx2 = uicontrol(<span class="string">'style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'Noise'</span>,<span class="string">'position'</span>,[0 endsliderY+30 80 10],<span class="string">'Value'</span>,NOISE,<span class="string">'callback'</span>,@ifNoise);
chkbx2 = uicontrol(<span class="string">'style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,<span class="string">'2Spike'</span>,<span class="string">'position'</span>,[0 endsliderY+40 80 10],<span class="string">'Value'</span>,TWO_SPIKES,<span class="string">'callback'</span>,@if2Spikes);
pb = uicontrol(<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="string">'Callback'</span>,@pb_callback,<span class="string">'position'</span>,[0 endsliderY+50 80 10]);
</pre><img vspace="5" hspace="5" src="LSMReservoirApp_03.png" alt=""> <h2 id="15">Text information string</h2><pre class="codeinput">infoStringTmpl ={<span class="string">'\alpha_G = &lt;alpha_G&gt;'</span>
    <span class="string">'frac_{in} = &lt;inFrac&gt;'</span>
    <span class="string">'\tau_{1e} = &lt;alpha1E&gt;'</span>
    <span class="string">'\tau_{2e} = &lt;alpha2E&gt;'</span>
    <span class="string">'\tau_{V} = &lt;alphaV&gt;'</span>
    <span class="string">'\tau_{1i} = &lt;alpha1I&gt;'</span>
    <span class="string">'\tau_{2i} = &lt;alpha2I&gt;'</span>
    <span class="string">'V_{th} = &lt;Vth&gt;'</span>
    <span class="string">'{\eta} = &lt;eta&gt;'</span>
    <span class="string">'{\lambda_{in}} = &lt;lambdaIn&gt;'</span>
    <span class="string">'{\DeltaT} = &lt;DeltaT&gt;'</span>
    <span class="string">'-------------------'</span>
    <span class="string">'W_{EE} = &lt;Wee&gt;'</span>
    <span class="string">'W_{EI} = &lt;Wei&gt;'</span>
    <span class="string">'W_{IE} = &lt;Wie&gt;'</span>
    <span class="string">'W_{II} = &lt;Wii&gt;'</span>};
<span class="comment">% slhan6=uicontrol('style','slider','String','wE-&gt;E','position',[0 0 100 10],'min',0,'max',1);</span>
<span class="comment">% slhan7=uicontrol('style','slider','String','inFrac','position',[100 0 100 10],'min',0,'max',1);</span>
<span class="comment">% slhan8=uicontrol('style','slider','String','alpha1','position',[0 10 100 10],'min',0,'max',1);</span>
<span class="comment">% slhan9=uicontrol('style','slider','String','alpha2','position',[100 10 100 10],'min',0,'max',1);</span>
</pre><h2 id="16">Create listener to push buttons</h2><pre class="codeinput">hSliderListener = addlistener(slhan, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatealpha1);
hSliderListener2 = addlistener(slhan2, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatealpha2);
hSliderListener3 = addlistener(slhan3, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatealpha3);
hSliderListener4 = addlistener(slhan4, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet4);
hSliderListener5 = addlistener(slhan5, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet5);
hSliderListener6 = addlistener(slhan6, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet6);
hSliderListener7 = addlistener(slhan7, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet7);
hSliderListener8 = addlistener(slhan8, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet8);
hSliderListener9 = addlistener(slhan9, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@updatet9);
hSliderListener10 = addlistener(slhan10, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update10);
hSliderListener11 = addlistener(slhan11, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update11);
hSliderListener12 = addlistener(slhan12, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update12);
hSliderListener13 = addlistener(slhan13, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update13);
hSliderListener14 = addlistener(slhan14, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update14);
hSliderListener15 = addlistener(slhan15, <span class="string">'Value'</span>,<span class="string">'PostSet'</span>,@update15);
<span class="comment">%hSliderListener3 = addlistener(slhan3, 'Value','PostSet',@updatealpha3);</span>
</pre><h2 id="17">Run main code</h2><pre class="codeinput">updateKt0();   <span class="comment">% updatepspplot();</span>
updateplot();
</pre><pre class="codeoutput">Plotupdated Kx(alpha1E,alpha2E):29.412(0.975,0.833) Kx(alpha1I,alpha2I):38.462(0.967,0.750) alpha_G:1.00000 alphaV:0.950 Vth:20.000
Wee : 3.00 Wei : 6.00 Wie : -2.00 Wii : -2.00

</pre><img vspace="5" hspace="5" src="LSMReservoirApp_04.png" alt=""> <h2 id="18">Helper Functions</h2><p>Below contains the callback and simulation functions They are evaluated based on the GUI response</p><h2 id="19">Generate New Network</h2><pre class="codeinput">    <span class="keyword">function</span> pb_callback(source,eventdata)
        <span class="comment">% Generate new network with different random seed</span>
        rng(<span class="string">'shuffle'</span>);
        [X,Xn,T,W,R,E] = createNetworkM([5,5,5],W0,2,K0,0.2,1E-3); <span class="comment">% spatially connected network</span>
        <span class="comment">%[X,Xn,Tau,W,R,E,N] = p2N5etwork(200,0.2,Wee,Wie);</span>
        Nres = length(E);
        V = zeros(Nres,1);
        v = zeros(Nres,3);
        I = zeros(Nres,3);
        spiked = logical(zeros(Nres,1));
        G = sparse(X,Xn,W);G0=G;

        <span class="comment">% STDP definitions</span>
        dGp = -1; dGn = 1;
        A = sparse(zeros(size(G)));
        A(E&gt;0,E&gt;0) = 1;A(E&gt;0,E&lt;0) = 1;
        A(E&lt;0,E&gt;0) = 1;A(E&lt;0,E&lt;0) = 1;
        A = A.*logical(G);
        updateplot();
    <span class="keyword">end</span>
</pre><h2 id="20">Update config values</h2><pre class="codeinput">    <span class="keyword">function</span> ifSTDP(source,eventdata)
        STDP = source.Value;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> ifPoisson(source,eventdata)
        POISSON = source.Value;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> ifNoise(source,eventdata)
        NOISE = source.Value;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> if2Spikes(source,eventdata)
        TWO_SPIKES = source.Value;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatealpha1(hObject,eventdata)
        alpha_G = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatealpha2(source,eventdata)
        inFrac = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatealpha3(source,eventdata)
        alpha1E = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateKt0();    updatepspplot();    updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updateKt0()
        Kt0e = (1-alpha1E)*(1-alpha2E)/(alpha1E-alpha2E)/dt; <span class="comment">% normalize by area</span>
        Kt0i = (1-alpha1I)*(1-alpha2I)/(alpha1I-alpha2I)/dt;
        Kt0(E&gt;0) = Kt0e;Kt0(E&lt;0) = Kt0i;
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatet4(source,eventdata)
        alpha2E = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateKt0();    updatepspplot();    updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatet5(source,eventdata)
        alphaV = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updatepspplot();
        updateplot();
    <span class="keyword">end</span>

    <span class="keyword">function</span> updatet6(source,eventdata)
        alpha1I = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateKt0();    updatepspplot();    updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatet7(source,eventdata)
        alpha2I = get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateKt0();    updatepspplot();    updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatet8(source,eventdata)
        Vth = 20*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateKt0();    updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> updatet9(source,eventdata)
        Wee = Wm*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        G0(E&gt;0,E&gt;0) = Wee*(A(E&gt;0,E&gt;0)~=0);  W0(1,1) = Wee;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update10(source,eventdata)
        Wei =  Wm*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        G0(E&gt;0,E&lt;0) = Wei*(A(E&gt;0,E&lt;0)~=0);  W0(1,2) = Wei;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update11(source,eventdata)
        Wie = -Wm*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        G0(E&lt;0,E&gt;0) = Wie*(A(E&lt;0,E&gt;0)~=0);  W0(2,1) = Wie;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update12(source,eventdata)
        Wii = -Wm*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        G0(E&lt;0,E&lt;0) = Wii*(A(E&lt;0,E&lt;0)~=0);  W0(2,2) = Wii;
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update13(source,eventdata)
        eta = Vth*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update14(source,eventdata)
        lambdaIn = 1/5/dt*get(eventdata.AffectedObject, <span class="string">'Value'</span>);
        updateplot();
    <span class="keyword">end</span>
    <span class="keyword">function</span> update15(source,eventdata)
        DeltaT = 800*get(eventdata.AffectedObject, <span class="string">'Value'</span>); <span class="comment">% in ms</span>
        DeltaT = ceil(DeltaT-400); <span class="comment">% make it integer</span>
        updateplot();
    <span class="keyword">end</span>

    <span class="keyword">function</span> updateInfoString()
        infoString = infoStringTmpl;
        s = sprintf(<span class="string">'%.4f'</span> ,alpha_G); infoString = strrep(infoString,<span class="string">'&lt;alpha_G&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,inFrac); infoString = strrep(infoString,<span class="string">'&lt;inFrac&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,alpha1E); infoString = strrep(infoString,<span class="string">'&lt;alpha1E&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,alpha2E); infoString = strrep(infoString,<span class="string">'&lt;alpha2E&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,alphaV); infoString = strrep(infoString,<span class="string">'&lt;alphaV&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,alpha1I); infoString = strrep(infoString,<span class="string">'&lt;alpha1I&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,alpha2I); infoString = strrep(infoString,<span class="string">'&lt;alpha2I&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,Vth); infoString = strrep(infoString,<span class="string">'&lt;Vth&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,Wee); infoString = strrep(infoString,<span class="string">'&lt;Wee&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,Wei); infoString = strrep(infoString,<span class="string">'&lt;Wei&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,Wie); infoString = strrep(infoString,<span class="string">'&lt;Wie&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,Wii); infoString = strrep(infoString,<span class="string">'&lt;Wii&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,eta); infoString = strrep(infoString,<span class="string">'&lt;eta&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,lambdaIn); infoString = strrep(infoString,<span class="string">'&lt;lambdaIn&gt;'</span>,s);
        s = sprintf(<span class="string">'%.4f'</span> ,DeltaT); infoString = strrep(infoString,<span class="string">'&lt;DeltaT&gt;'</span>,s);
        infoText.String = infoString;

    <span class="keyword">end</span>
</pre><h2 id="21">Show synaptic model</h2><pre class="codeinput">    <span class="keyword">function</span> updatepspplot()
        ve = zeros(1,2);
        vi = zeros(1,2);
        v = zeros(1);
        <span class="keyword">for</span> k = 1:100
            ve = ve.*[alpha1E alpha2E]+double(sum(k==[1]));
            vi = vi.*[alpha1I alpha2I]+double(sum(k==[1]));
            v = v.*alphaV+double(sum(k==[1]));
            vloge(k) =  Kt0e*ve*[1 -1]';
            vlogi(k) =  Kt0i*vi*[1 -1]';
            vlog(k) = (1-alphaV)/alphaV/dt* v;
        <span class="keyword">end</span>
        plot(vloge,<span class="string">'b'</span>); hold <span class="string">on</span>;
        plot(vlogi,<span class="string">'r'</span>);
        plot(vlog,<span class="string">'g'</span>);hold <span class="string">off</span>;
        drawnow;title(<span class="string">'PSP &amp; LIF Model(Normalized)'</span>);
        xlabel(<span class="string">'time(ms'</span>); ylabel(<span class="string">'V'</span>);
        legend(<span class="string">'Excitatory PSP'</span>,<span class="string">'Inhibitory PSP'</span>,<span class="string">'LIF Model'</span>);
    <span class="keyword">end</span>
</pre><h2 id="22">Show reservoir spike distribution by neuron</h2><pre class="codeinput">    <span class="keyword">function</span> showDist()
        <span class="comment">% show spike distribution in reservoir</span>
        axes(psp_subplot);
        resDist=sort(sum(1.0*spikedLog,2))/(K*dt);
        h0=fill([1 1:length(resDist) length(resDist)],[0; resDist; 0],<span class="string">'g'</span>,<span class="string">'FaceAlpha'</span>,0.4,<span class="string">'EdgeAlpha'</span>,0.1); drawnow;
        xlabel(<span class="string">'Sorted Neuron #'</span>); ylabel(<span class="string">'Spike Rate(s^{-1}/neuron)'</span>);
        title(<span class="string">'Reservoir Spike Distribution'</span>);
    <span class="keyword">end</span>
</pre><h2 id="23">Update main plot</h2><p>simulates the dynamics and plots the output</p><pre class="codeinput">    <span class="keyword">function</span> updateplot()
        figure(fig_handle);
        s = sprintf(<span class="string">"Kx(alpha1E,alpha2E):%.3f(%1.3f,%1.3f) Kx(alpha1I,alpha2I):%.3f(%1.3f,%1.3f) alpha_G:%.5f alphaV:%.3f Vth:%.3f"</span>,Kt0e,alpha1E,alpha2E,Kt0i,alpha1I,alpha2I,alpha_G,alphaV,Vth);
        axes(input_subplot);hold <span class="string">off</span>;
        s2 = sprintf(<span class="string">"Wee : %.2f Wei : %.2f Wie : %.2f Wii : %.2f\r\n"</span>,Wee,Wei,Wie,Wii);
        <span class="comment">%text(0,Nres,char(s),'Color','r','FontSize',10);</span>
        fprintf(<span class="string">"Plotupdated %s\r\n%s\r\n"</span>,s,s2);
        updateInfoString();
        VLog =[];
        GsumLog = zeros(0,2,2);

        IappLog=sparse([]);
        V = zeros(Nres,1); <span class="comment">% reset valuess</span>
        v = zeros(Nres,3);
        I = zeros(Nres,3);
        G = G0;
        spikedLog(:)=0;
        k_spiked = -Inf*ones(Nres,1);
        inhN = find(E&lt;0);
        rng(0);
        <span class="keyword">for</span> k =1:K
            Iapp(:)=0;
            <span class="comment">%if(k&lt;500)Iapp(1:floor(Nres*inFrac)) = rand(floor(Nres*inFrac),1)&lt;0.05; end;</span>
            <span class="comment">%if(k==10 ||(k==250 || k==260)|| (k==500 || k==510))Iapp(1:floor(Nres*inFrac)) =100000; end;%impulse current (all excitatory spike)</span>
            <span class="comment">%if((k&gt;=10 &amp;&amp; k&lt;200) || (k&gt;=400 &amp;&amp; k&lt;600))</span>
            <span class="keyword">if</span>(TWO_SPIKES)
                <span class="keyword">if</span>(k==K/2 || k==K/2+DeltaT)
                    Iapp(1:floor(Nres*inFrac)) = 10000*(ones(1,floor(Nres*inFrac)));
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="keyword">if</span>(POISSON)
                <span class="keyword">if</span>(k&gt;=10 &amp;&amp; k&lt;K/4)
                    Iapp(1:floor(Nres*inFrac)) = 10000*(rand(1,floor(Nres*inFrac))&lt;lambdaIn*dt);
                <span class="keyword">end</span>
            <span class="keyword">else</span> <span class="keyword">if</span>(~TWO_SPIKES)
                    <span class="keyword">if</span>(k==10 || k==110||k==210||k==310)

                        Iapp(1:floor(Nres*inFrac)) = 10000*(rand(1,floor(Nres*inFrac))&gt;0);
                        <span class="keyword">if</span>(k==400) rng(0);<span class="keyword">end</span>
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            Iapp(inhN) = 0; IappLog(:,end+1) = Iapp; <span class="comment">% no current to inhibitory neurons, log applied current</span>
            V = alphaV*V+alpha_G*G'*I(:,mod(k-1,2)+1)*dt+Gin.*Iapp*dt+NOISE*eta*randn(Nres,1)*sqrt(dt);
            spikedOld = spiked; spiked = V&gt;Vth;             V(spiked) = 0;V(V&lt;0) = 0;
            spiked((k-k_spiked)&lt;=2)=0;
            k_spiked(spiked)=k; <span class="comment">% refractory period</span>

            v(:,1:2) = [alpha1 alpha2].*v(:,1:2)+spiked;
            I(:,mod(k,3)+1) = Kt0.*v(:,1:2)*[1 -1]'; <span class="comment">% second order synaptic model</span>
            <span class="comment">% Update reservoir weights</span>
            <span class="keyword">if</span>(STDP)
                v(:,3) = alpha3.*v(:,3)+spikedOld;
                Ag = spiked.*v(:,3)';
                G = G+(dGp*Ag+dGn*Ag').*A;
                GsumLog(k,1,1) =sum(sum(G(E&gt;0,E&gt;0)));GsumLog(k,1,2) =sum(sum(G(E&gt;0,E&lt;0)));
                GsumLog(k,2,1) =sum(sum(G(E&lt;0,E&gt;0)));GsumLog(k,2,2) =sum(sum(G(E&lt;0,E&lt;0)));
            <span class="keyword">end</span>
            VLog(:,end+1)=V;
            spikedLog(:,k)=spiked;
        <span class="keyword">end</span>
        <span class="keyword">if</span>(STDP)
            axes(glog_subplot);
            plot(GsumLog(:,1,1),<span class="string">'b'</span>); hold <span class="string">on</span>;plot(GsumLog(:,1,2),<span class="string">'c'</span>);
            plot(GsumLog(:,2,1),<span class="string">'m'</span>);plot(GsumLog(:,2,2),<span class="string">'r'</span>);hold <span class="string">off</span>;
        <span class="keyword">else</span>
            plot(0,0);
        <span class="keyword">end</span>
        axes(raster_subplot);
        imagesc(VLog); colorbar;hold <span class="string">on</span>;
        [s,ts]=find(spikedLog.*(E&gt;0));   plot(ts,s,<span class="string">'.'</span>,<span class="string">'MarkerSize'</span>,0.01,<span class="string">'Color'</span>,<span class="string">'g'</span>);
        [s,ts]=find(spikedLog.*(E&lt;0));    plot(ts,s,<span class="string">'.'</span>,<span class="string">'MarkerSize'</span>,0.01,<span class="string">'Color'</span>,<span class="string">'r'</span>); hold <span class="string">off</span>;
        spikesK = full(sum(spikedLog,1));
        spikesKE= full(sum(spikedLog(E&gt;0,:),1));
        spikesKI =full(sum(spikedLog(E&lt;0,:),1));
        spikesK1=spikesK;
        spikesK = conv(spikesK,ones(1,20)/20); <span class="comment">% plot spikes over 2ms window (=refractory period)</span>
        spikesKE = conv(spikesKE,ones(1,20)/20); <span class="comment">% plot spikes over 2ms window (=refractory period)</span>
        spikesKI = conv(spikesKI,ones(1,20)/20); <span class="comment">% plot spikes over 2ms window (=refractory period)</span>
        xlim([0 k]); ylim([0 Nres]); title(<span class="string">'Output Raster and Neuron Potential'</span>);
        xlabel(<span class="string">'time(ms)'</span>); ylabel(<span class="string">'Neuron ID'</span>);
        axes(input_subplot);
        spikedLog=logical(spikedLog);
        [s,ts]=find(IappLog);   plot(ts,s,<span class="string">'.'</span>,<span class="string">'MarkerSize'</span>,0.1,<span class="string">'Color'</span>,<span class="string">'k'</span>); hold <span class="string">on</span>;
        [s,ts]=find(spikedLog.*(E&gt;0));   plot(ts,s,<span class="string">'.'</span>,<span class="string">'MarkerSize'</span>,0.01,<span class="string">'Color'</span>,<span class="string">'b'</span>);
        [s,ts]=find(spikedLog.*(E&lt;0));    plot(ts,s,<span class="string">'.'</span>,<span class="string">'MarkerSize'</span>,0.01,<span class="string">'Color'</span>,<span class="string">'r'</span>); hold <span class="string">off</span>;
        hold <span class="string">off</span>; xlabel(<span class="string">'time(ms)'</span>); ylabel(<span class="string">'Neuron ID'</span>);
        xlim([0 k]); ylim([0 Nres]);title(<span class="string">'Input Spikes &amp; Output Raster'</span>);
        axes(activity_subplot);
        plot(spikesKE(1:end),<span class="string">'-o'</span>,<span class="string">'Color'</span>,<span class="string">'b'</span>,<span class="string">'MarkerSize'</span>,2); hold <span class="string">on</span>;
        plot(spikesKI(1:end),<span class="string">'-o'</span>,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'MarkerSize'</span>,2);
        plot(spikesK(1:end),<span class="string">'-o'</span>,<span class="string">'Color'</span>,<span class="string">'g'</span>,<span class="string">'MarkerSize'</span>,2); hold <span class="string">off</span>; xlim([1 K]);
        title(<span class="string">'Network Activity'</span>); legend(<span class="string">'Excitatory'</span>,<span class="string">'Inhibitory'</span>,<span class="string">'Total'</span>);
        xlabel(<span class="string">'time(ms)'</span>); ylabel(<span class="string">'# of firing neurons'</span>);
        showDist();
        set(gcf,<span class="string">'Color'</span>,<span class="string">'w'</span>);set(findobj(gcf,<span class="string">'type'</span>,<span class="string">'axes'</span>),<span class="string">'FontName'</span>,<span class="string">'Consolas'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="string">'LineWidth'</span>, 1);
        <span class="keyword">if</span>(SAVE_VIDEO)
            frame = getframe(gcf);
            writeVideo(writerObj,frame);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Simulate 3D SNN reservoir in Liquid State Machine (LSM)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Simulates reservoir in a LSM and is useful in :                         
%   * tuning the synaptic weights to get various dynamics(oscillatory,
%   decaying, saturation)
%   * observe effect of changing individual network parameter to find
%   sensitivity of parameters
%
% Author - Ajinkya Gorad 
% LSMReservoir@2019 (version-0.8)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


function LSMReservoirApp
%% Reset random number generator
rng(0);
%% Default configuration settings (could be modified in GUI)
STDP = 0;       % Spike Timing Dependent Plasticity
SAVE_VIDEO=0;   % Save the simulation frame by frame for each param setting
NOISE = 0;      % noise in membrane potential of neurons
TWO_SPIKES = 0; % Only give two input spikes
POISSON =0;     % Poisson spike inputs
%% Configuration parameters
eta = 0;        % noise level (NOISE only)
lambdaIn = 10;  % Poisson input spike rate (POISSON only)
DeltaT = 0;     % Separation between two spike input (TWO_SPIKES only)
%% Reservoir parameters
W0 = [3 6;-2 -2];   % Initial weights in the reservoir (E->E, E->I; I->E, I->I) Excitatory(E), Inhibitory(I)
K0 = [0.45 0.3;0.6 0.15];   % Probability coefficients for reservoir connections
Wee  = W0(1,1); Wei= W0(1,2); Wie= W0(2,1); Wii = W0(2,2); % assign individual weights
Wm =50;              % Maximum limit for reservoir weight synaptic scaling (SLIDER)
alpha_G = 1;            % default synaptic scaling parameter
resSize= [5 5 5];    % 3D reservoir size
r0 = 2;              % effective connectivity distance parameter for gaussian profile
f_inhibit=0.2;       % fraction of inhibitory neurons in reservoir
d_syn = 1E-3;        % Synaptic Delay in reservoir (FIXED)
%%
if(SAVE_VIDEO)
    writerObj = VideoWriter('media\STOCH_RES2.mp4');
    open(writerObj);
end


%% Create 3D reservoir network
% createNetworkM creates an multidimensional graph on N-D grid with
% dimensions(M) = lenght(resSize) and neuron at each ND-point (n1,...,nM)
% X : source node of network graph
% Xn : destination node of network graph
% T : synaptic delay for each neuron (FIXED)
% W : weight of each synapse
% R : coordinates of each neuron
% E : value for choosing excitatory(1)/inhibitory(-1) neuron

[X,Xn,T,W,R,E] = createNetworkM(resSize,W0,r0,K0,f_inhibit,d_syn); % gaussian probablistically connected network

%% Get secondary parameters
Nres = length(E);   % number of reservoir neurons
V = zeros(Nres,1);  % Membrane potential of reservoir Neurons
v = zeros(Nres,3);  % Synaptic traces
I = zeros(Nres,3);  % Neuron input current
spiked = logical(zeros(Nres,1)); % to store spiked neurons at an instant
spikedLog =logical(sparse([])); % to store spiked neurons in all simulated time <K
G = sparse(X,Xn,W); % Sparse matrix is better to store loosely connected networks
G0=G;    % save default configuration for network weights and connectivity

% STDP definitions
dGp = -1; dGn = 1; % weight/conductance (G) update rate
A = sparse(zeros(size(G)));
A(E>0,E>0) = 1;A(E>0,E<0) = 1; % Define coefficients for STDP
A(E<0,E>0) = 1;A(E<0,E<0) = 1; %  -;;-
A = A.*logical(G);  % get the graph connectivity matrix A

%% Input mapping of spikes
Gin=ones(Nres,1)*8;     % Defines input weights for each neuron
Iapp = zeros(Nres,1);   % Externally applied current for each neuron
inFrac=0.9;             % Fraction of reservoir  neurons which take input
%% Values from the Literature : Zhang et al. 2015
dt = 1E-3; % Define time step of simulation
K = 2000;  % Define time of simulation
alphaV = (1-dt/20E-3); % membrane decay constant (discrete)
alpha1E = (1-dt/40E-3);alpha2E =(1-dt/6E-3); % synaptic trace decay constants
alpha3stdp = (1-dt/10E-3); % used in STDP
alpha1I = (1-dt/30E-3); alpha2I = (1-dt/4E-3);
% create and assign matrices
alpha1 = zeros(Nres,1); alpha2 = alpha1; alpha3 = alpha1;
Kt0e=0;Kt0i=0;Kt0=zeros(Nres,1);
alpha1(E>0) = alpha1E; alpha2(E>0) = alpha2E; alpha3(:) = alpha3stdp;
alpha1(E<0) = alpha1I; alpha2(E<0) = alpha2I;
Vth = 20;       % Threshold voltage (mV)

%% Update synaptic scaling
%updateKt0();

%% Create figure handles and GUI
fig_handle = figure('name','simulation'); % Main figure window
set(fig_handle, 'Position', [0, 0, 1280, 600]); % Defines the size of main window
text_subplot = axes('Position',[0 0 0.2 1],'Visible','off');infoText=text(0.05,0.65,' ','FontSize',10); % Information region
raster_subplot = axes('Position',[.2 0.1 .55 .35]);     % reservoir spikes
input_subplot = axes('Position',[.2 0.6 .55 .35]);      % input Spikes (to each neuron)
psp_subplot = axes('Position',[.8 0.6 .15 .35]);        % Synaptic model/Reservoir distribution
activity_subplot = axes('Position',[.8 0.1 .15 0.35]);  % Spike activity with time
glog_subplot = axes('Position',[0.025 0.8 0.15 0.2],'Visible','off'); % Weight update (STDP only)
set(gcf,'Color','w');
%% Create sliders
axes(text_subplot);
slidebarW=200; % width in pixel for slider
slhan=uicontrol('style','slider','String','alpha_G','TooltipString','alpha_G','position',[0 0 slidebarW 10],'min',0,'max',1);
slhan2=uicontrol('style','slider','String','inFrac','TooltipString','inFrac','position',[0 10 slidebarW 10],'min',0,'max',1);
slhan3=uicontrol('style','slider','String','alpha1E','TooltipString','alpha1E','position',[0 20 slidebarW 10],'min',0,'max',1);
slhan4=uicontrol('style','slider','String','alpha2E','TooltipString','alpha2E','position',[0 30 slidebarW 10],'min',0,'max',1);
slhan5=uicontrol('style','slider','String','alphaV','TooltipString','alphaV','position',[0 40 slidebarW 10],'min',0,'max',1);
slhan6=uicontrol('style','slider','String','alpha1I','TooltipString','alpha1I','position',[0 50 slidebarW 10],'min',0,'max',1);
slhan7=uicontrol('style','slider','String','alpha2I','TooltipString','alpha2I','position',[0 60 slidebarW 10],'min',0,'max',1);
slhan8=uicontrol('style','slider','String','Vth','TooltipString','Vth','position',[0 70 slidebarW 10],'min',0,'max',1);
slhan9=uicontrol('style','slider','String','Wee','TooltipString','Wee','position',[0 80 slidebarW 10],'min',0,'max',1,'SliderStep',[1/10/50 2/50],'BackgroundColor',[0.0 0.5 0.2],'Value',Wee/Wm);
slhan10=uicontrol('style','slider','String','Wei','TooltipString','Wei','position',[0 90 slidebarW 10],'min',0,'max',1,'SliderStep',[1/10/50 2/50],'BackgroundColor',[0.2 0.5 0.2],'Value',Wei/Wm);
slhan11=uicontrol('style','slider','String','Wie','TooltipString','Wie','position',[0 100 slidebarW 10],'min',0,'max',1,'SliderStep',[1/10/50 2/50],'BackgroundColor',[0.5 0.2 0.2],'Value',-Wie/Wm);
slhan12=uicontrol('style','slider','String','Wii','TooltipString','Wii','position',[0 110 slidebarW 10],'min',0,'max',1,'SliderStep',[1/10/50 2/50],'BackgroundColor',[0.5 0.0 0.2],'Value',-Wii/Wm);
slhan13=uicontrol('style','slider','String','Noise','TooltipString','Noise','position',[0 120 slidebarW 10],'min',0,'max',1);
slhan14=uicontrol('style','slider','String','lambdaIn','TooltipString','lambdaIn','position',[0 130 slidebarW 10],'min',0,'max',1);
slhan15=uicontrol('style','slider','String','DeltaT','TooltipString','DeltaT','position',[0 140 slidebarW 10],'min',0,'max',1, 'SliderStep',[1/800 50/800]);

%% Create checkboxes
endsliderY = 140; % width in pixel for checkbox
chkbx1 = uicontrol('style','checkbox','String','STDP','position',[0 endsliderY+10 80 10],'Value',STDP,'callback',@ifSTDP);
chkbx2 = uicontrol('style','checkbox','String','PoissonTrain','position',[0 endsliderY+20 80 10],'Value',POISSON,'callback',@ifPoisson);
chkbx2 = uicontrol('style','checkbox','String','Noise','position',[0 endsliderY+30 80 10],'Value',NOISE,'callback',@ifNoise);
chkbx2 = uicontrol('style','checkbox','String','2Spike','position',[0 endsliderY+40 80 10],'Value',TWO_SPIKES,'callback',@if2Spikes);
pb = uicontrol('Style','pushbutton','Callback',@pb_callback,'position',[0 endsliderY+50 80 10]);
%% Text information string
infoStringTmpl ={'\alpha_G = <alpha_G>'
    'frac_{in} = <inFrac>'
    '\tau_{1e} = <alpha1E>'
    '\tau_{2e} = <alpha2E>'
    '\tau_{V} = <alphaV>'
    '\tau_{1i} = <alpha1I>'
    '\tau_{2i} = <alpha2I>'
    'V_{th} = <Vth>'
    '{\eta} = <eta>'
    '{\lambda_{in}} = <lambdaIn>'
    '{\DeltaT} = <DeltaT>'
    'REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-'
    'W_{EE} = <Wee>'
    'W_{EI} = <Wei>'
    'W_{IE} = <Wie>'
    'W_{II} = <Wii>'};
% slhan6=uicontrol('style','slider','String','wE->E','position',[0 0 100 10],'min',0,'max',1);
% slhan7=uicontrol('style','slider','String','inFrac','position',[100 0 100 10],'min',0,'max',1);
% slhan8=uicontrol('style','slider','String','alpha1','position',[0 10 100 10],'min',0,'max',1);
% slhan9=uicontrol('style','slider','String','alpha2','position',[100 10 100 10],'min',0,'max',1);
%% Create listener to push buttons
hSliderListener = addlistener(slhan, 'Value','PostSet',@updatealpha1);
hSliderListener2 = addlistener(slhan2, 'Value','PostSet',@updatealpha2);
hSliderListener3 = addlistener(slhan3, 'Value','PostSet',@updatealpha3);
hSliderListener4 = addlistener(slhan4, 'Value','PostSet',@updatet4);
hSliderListener5 = addlistener(slhan5, 'Value','PostSet',@updatet5);
hSliderListener6 = addlistener(slhan6, 'Value','PostSet',@updatet6);
hSliderListener7 = addlistener(slhan7, 'Value','PostSet',@updatet7);
hSliderListener8 = addlistener(slhan8, 'Value','PostSet',@updatet8);
hSliderListener9 = addlistener(slhan9, 'Value','PostSet',@updatet9);
hSliderListener10 = addlistener(slhan10, 'Value','PostSet',@update10);
hSliderListener11 = addlistener(slhan11, 'Value','PostSet',@update11);
hSliderListener12 = addlistener(slhan12, 'Value','PostSet',@update12);
hSliderListener13 = addlistener(slhan13, 'Value','PostSet',@update13);
hSliderListener14 = addlistener(slhan14, 'Value','PostSet',@update14);
hSliderListener15 = addlistener(slhan15, 'Value','PostSet',@update15);
%hSliderListener3 = addlistener(slhan3, 'Value','PostSet',@updatealpha3);

%% Run main code
updateKt0();   % updatepspplot();
updateplot();

%% Helper Functions
% Below contains the callback and simulation functions 
% They are evaluated based on the GUI response
%% Generate New Network
    function pb_callback(source,eventdata)
        % Generate new network with different random seed
        rng('shuffle');
        [X,Xn,T,W,R,E] = createNetworkM([5,5,5],W0,2,K0,0.2,1E-3); % spatially connected network
        %[X,Xn,Tau,W,R,E,N] = p2N5etwork(200,0.2,Wee,Wie);
        Nres = length(E);
        V = zeros(Nres,1);
        v = zeros(Nres,3);
        I = zeros(Nres,3);
        spiked = logical(zeros(Nres,1));
        G = sparse(X,Xn,W);G0=G;
        
        % STDP definitions
        dGp = -1; dGn = 1;
        A = sparse(zeros(size(G)));
        A(E>0,E>0) = 1;A(E>0,E<0) = 1;
        A(E<0,E>0) = 1;A(E<0,E<0) = 1;
        A = A.*logical(G);
        updateplot();
    end
%% Update config values
    function ifSTDP(source,eventdata)
        STDP = source.Value;
        updateplot();
    end
    function ifPoisson(source,eventdata)
        POISSON = source.Value;
        updateplot();
    end
    function ifNoise(source,eventdata)
        NOISE = source.Value;
        updateplot();
    end
    function if2Spikes(source,eventdata)
        TWO_SPIKES = source.Value;
        updateplot();
    end
    function updatealpha1(hObject,eventdata)
        alpha_G = get(eventdata.AffectedObject, 'Value');
        updateplot();
    end
    function updatealpha2(source,eventdata)
        inFrac = get(eventdata.AffectedObject, 'Value');
        updateplot();
    end
    function updatealpha3(source,eventdata)
        alpha1E = get(eventdata.AffectedObject, 'Value');
        updateKt0();    updatepspplot();    updateplot();
    end
    function updateKt0()
        Kt0e = (1-alpha1E)*(1-alpha2E)/(alpha1E-alpha2E)/dt; % normalize by area
        Kt0i = (1-alpha1I)*(1-alpha2I)/(alpha1I-alpha2I)/dt;
        Kt0(E>0) = Kt0e;Kt0(E<0) = Kt0i;
    end
    function updatet4(source,eventdata)
        alpha2E = get(eventdata.AffectedObject, 'Value');
        updateKt0();    updatepspplot();    updateplot();
    end
    function updatet5(source,eventdata)
        alphaV = get(eventdata.AffectedObject, 'Value');
        updatepspplot();
        updateplot();
    end

    function updatet6(source,eventdata)
        alpha1I = get(eventdata.AffectedObject, 'Value');
        updateKt0();    updatepspplot();    updateplot();
    end
    function updatet7(source,eventdata)
        alpha2I = get(eventdata.AffectedObject, 'Value');
        updateKt0();    updatepspplot();    updateplot();
    end
    function updatet8(source,eventdata)
        Vth = 20*get(eventdata.AffectedObject, 'Value');
        updateKt0();    updateplot();
    end
    function updatet9(source,eventdata)
        Wee = Wm*get(eventdata.AffectedObject, 'Value');
        G0(E>0,E>0) = Wee*(A(E>0,E>0)~=0);  W0(1,1) = Wee;
        updateplot();
    end
    function update10(source,eventdata)
        Wei =  Wm*get(eventdata.AffectedObject, 'Value');
        G0(E>0,E<0) = Wei*(A(E>0,E<0)~=0);  W0(1,2) = Wei;
        updateplot();
    end
    function update11(source,eventdata)
        Wie = -Wm*get(eventdata.AffectedObject, 'Value');
        G0(E<0,E>0) = Wie*(A(E<0,E>0)~=0);  W0(2,1) = Wie;
        updateplot();
    end
    function update12(source,eventdata)
        Wii = -Wm*get(eventdata.AffectedObject, 'Value');
        G0(E<0,E<0) = Wii*(A(E<0,E<0)~=0);  W0(2,2) = Wii;
        updateplot();
    end
    function update13(source,eventdata)
        eta = Vth*get(eventdata.AffectedObject, 'Value');
        updateplot();
    end
    function update14(source,eventdata)
        lambdaIn = 1/5/dt*get(eventdata.AffectedObject, 'Value');
        updateplot();
    end
    function update15(source,eventdata)
        DeltaT = 800*get(eventdata.AffectedObject, 'Value'); % in ms
        DeltaT = ceil(DeltaT-400); % make it integer
        updateplot();
    end

    function updateInfoString()
        infoString = infoStringTmpl;
        s = sprintf('%.4f' ,alpha_G); infoString = strrep(infoString,'<alpha_G>',s);
        s = sprintf('%.4f' ,inFrac); infoString = strrep(infoString,'<inFrac>',s);
        s = sprintf('%.4f' ,alpha1E); infoString = strrep(infoString,'<alpha1E>',s);
        s = sprintf('%.4f' ,alpha2E); infoString = strrep(infoString,'<alpha2E>',s);
        s = sprintf('%.4f' ,alphaV); infoString = strrep(infoString,'<alphaV>',s);
        s = sprintf('%.4f' ,alpha1I); infoString = strrep(infoString,'<alpha1I>',s);
        s = sprintf('%.4f' ,alpha2I); infoString = strrep(infoString,'<alpha2I>',s);
        s = sprintf('%.4f' ,Vth); infoString = strrep(infoString,'<Vth>',s);
        s = sprintf('%.4f' ,Wee); infoString = strrep(infoString,'<Wee>',s);
        s = sprintf('%.4f' ,Wei); infoString = strrep(infoString,'<Wei>',s);
        s = sprintf('%.4f' ,Wie); infoString = strrep(infoString,'<Wie>',s);
        s = sprintf('%.4f' ,Wii); infoString = strrep(infoString,'<Wii>',s);
        s = sprintf('%.4f' ,eta); infoString = strrep(infoString,'<eta>',s);
        s = sprintf('%.4f' ,lambdaIn); infoString = strrep(infoString,'<lambdaIn>',s);
        s = sprintf('%.4f' ,DeltaT); infoString = strrep(infoString,'<DeltaT>',s);
        infoText.String = infoString;
        
    end

%% Show synaptic model
    function updatepspplot()
        ve = zeros(1,2);
        vi = zeros(1,2);
        v = zeros(1);
        for k = 1:100
            ve = ve.*[alpha1E alpha2E]+double(sum(k==[1]));
            vi = vi.*[alpha1I alpha2I]+double(sum(k==[1]));
            v = v.*alphaV+double(sum(k==[1]));
            vloge(k) =  Kt0e*ve*[1 -1]';
            vlogi(k) =  Kt0i*vi*[1 -1]';
            vlog(k) = (1-alphaV)/alphaV/dt* v;
        end
        plot(vloge,'b'); hold on;
        plot(vlogi,'r');
        plot(vlog,'g');hold off;
        drawnow;title('PSP & LIF Model(Normalized)');
        xlabel('time(ms'); ylabel('V');
        legend('Excitatory PSP','Inhibitory PSP','LIF Model');
    end
%% Show reservoir spike distribution by neuron
    function showDist()
        % show spike distribution in reservoir
        axes(psp_subplot);
        resDist=sort(sum(1.0*spikedLog,2))/(K*dt);
        h0=fill([1 1:length(resDist) length(resDist)],[0; resDist; 0],'g','FaceAlpha',0.4,'EdgeAlpha',0.1); drawnow;
        xlabel('Sorted Neuron #'); ylabel('Spike Rate(s^{-1}/neuron)');
        title('Reservoir Spike Distribution');
    end
%% Update main plot
% simulates the dynamics and plots the output
    function updateplot()
        figure(fig_handle);
        s = sprintf("Kx(alpha1E,alpha2E):%.3f(%1.3f,%1.3f) Kx(alpha1I,alpha2I):%.3f(%1.3f,%1.3f) alpha_G:%.5f alphaV:%.3f Vth:%.3f",Kt0e,alpha1E,alpha2E,Kt0i,alpha1I,alpha2I,alpha_G,alphaV,Vth);
        axes(input_subplot);hold off;
        s2 = sprintf("Wee : %.2f Wei : %.2f Wie : %.2f Wii : %.2f\r\n",Wee,Wei,Wie,Wii);
        %text(0,Nres,char(s),'Color','r','FontSize',10);
        fprintf("Plotupdated %s\r\n%s\r\n",s,s2);
        updateInfoString();
        VLog =[];
        GsumLog = zeros(0,2,2);
        
        IappLog=sparse([]);
        V = zeros(Nres,1); % reset valuess
        v = zeros(Nres,3);
        I = zeros(Nres,3);
        G = G0;
        spikedLog(:)=0;
        k_spiked = -Inf*ones(Nres,1);
        inhN = find(E<0);
        rng(0);
        for k =1:K
            Iapp(:)=0;
            %if(k<500)Iapp(1:floor(Nres*inFrac)) = rand(floor(Nres*inFrac),1)<0.05; end;
            %if(k==10 ||(k==250 || k==260)|| (k==500 || k==510))Iapp(1:floor(Nres*inFrac)) =100000; end;%impulse current (all excitatory spike)
            %if((k>=10 && k<200) || (k>=400 && k<600))
            if(TWO_SPIKES)
                if(k==K/2 || k==K/2+DeltaT)
                    Iapp(1:floor(Nres*inFrac)) = 10000*(ones(1,floor(Nres*inFrac)));
                end
            end
            if(POISSON)
                if(k>=10 && k<K/4)
                    Iapp(1:floor(Nres*inFrac)) = 10000*(rand(1,floor(Nres*inFrac))<lambdaIn*dt);
                end
            else if(~TWO_SPIKES)
                    if(k==10 || k==110||k==210||k==310)
                        
                        Iapp(1:floor(Nres*inFrac)) = 10000*(rand(1,floor(Nres*inFrac))>0);
                        if(k==400) rng(0);end
                    end
                end
            end
            Iapp(inhN) = 0; IappLog(:,end+1) = Iapp; % no current to inhibitory neurons, log applied current
            V = alphaV*V+alpha_G*G'*I(:,mod(k-1,2)+1)*dt+Gin.*Iapp*dt+NOISE*eta*randn(Nres,1)*sqrt(dt);
            spikedOld = spiked; spiked = V>Vth;             V(spiked) = 0;V(V<0) = 0;
            spiked((k-k_spiked)<=2)=0;
            k_spiked(spiked)=k; % refractory period
            
            v(:,1:2) = [alpha1 alpha2].*v(:,1:2)+spiked;
            I(:,mod(k,3)+1) = Kt0.*v(:,1:2)*[1 -1]'; % second order synaptic model
            % Update reservoir weights
            if(STDP)
                v(:,3) = alpha3.*v(:,3)+spikedOld;
                Ag = spiked.*v(:,3)';
                G = G+(dGp*Ag+dGn*Ag').*A;
                GsumLog(k,1,1) =sum(sum(G(E>0,E>0)));GsumLog(k,1,2) =sum(sum(G(E>0,E<0)));
                GsumLog(k,2,1) =sum(sum(G(E<0,E>0)));GsumLog(k,2,2) =sum(sum(G(E<0,E<0)));
            end
            VLog(:,end+1)=V;
            spikedLog(:,k)=spiked;
        end
        if(STDP)
            axes(glog_subplot);
            plot(GsumLog(:,1,1),'b'); hold on;plot(GsumLog(:,1,2),'c');
            plot(GsumLog(:,2,1),'m');plot(GsumLog(:,2,2),'r');hold off;
        else
            plot(0,0);
        end
        axes(raster_subplot);
        imagesc(VLog); colorbar;hold on;
        [s,ts]=find(spikedLog.*(E>0));   plot(ts,s,'.','MarkerSize',0.01,'Color','g');
        [s,ts]=find(spikedLog.*(E<0));    plot(ts,s,'.','MarkerSize',0.01,'Color','r'); hold off;
        spikesK = full(sum(spikedLog,1));
        spikesKE= full(sum(spikedLog(E>0,:),1));
        spikesKI =full(sum(spikedLog(E<0,:),1));
        spikesK1=spikesK;
        spikesK = conv(spikesK,ones(1,20)/20); % plot spikes over 2ms window (=refractory period)
        spikesKE = conv(spikesKE,ones(1,20)/20); % plot spikes over 2ms window (=refractory period)
        spikesKI = conv(spikesKI,ones(1,20)/20); % plot spikes over 2ms window (=refractory period)
        xlim([0 k]); ylim([0 Nres]); title('Output Raster and Neuron Potential');
        xlabel('time(ms)'); ylabel('Neuron ID');
        axes(input_subplot);
        spikedLog=logical(spikedLog);
        [s,ts]=find(IappLog);   plot(ts,s,'.','MarkerSize',0.1,'Color','k'); hold on;
        [s,ts]=find(spikedLog.*(E>0));   plot(ts,s,'.','MarkerSize',0.01,'Color','b');
        [s,ts]=find(spikedLog.*(E<0));    plot(ts,s,'.','MarkerSize',0.01,'Color','r'); hold off;
        hold off; xlabel('time(ms)'); ylabel('Neuron ID');
        xlim([0 k]); ylim([0 Nres]);title('Input Spikes & Output Raster');
        axes(activity_subplot);
        plot(spikesKE(1:end),'-o','Color','b','MarkerSize',2); hold on;
        plot(spikesKI(1:end),'-o','Color','r','MarkerSize',2);
        plot(spikesK(1:end),'-o','Color','g','MarkerSize',2); hold off; xlim([1 K]);
        title('Network Activity'); legend('Excitatory','Inhibitory','Total');
        xlabel('time(ms)'); ylabel('# of firing neurons');
        showDist();
        set(gcf,'Color','w');set(findobj(gcf,'type','axes'),'FontName','Consolas','FontSize',10,'FontWeight','Bold', 'LineWidth', 1);
        if(SAVE_VIDEO)
            frame = getframe(gcf);
            writeVideo(writerObj,frame);
        end
    end
end

##### SOURCE END #####
--></body></html>